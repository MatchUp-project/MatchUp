<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      th:replace="fragments/layout :: layout(~{::content})">
<div th:fragment="content">
    <style>
        .content-box { white-space: pre-line; font-size: 1.05rem; line-height: 1.6rem; }
        .comment-box { padding: 8px 0; border-bottom: 1px solid #e5e5e5; font-size: 0.95rem; }
        .depth-0 { margin-left: 0; }
        .depth-1 { margin-left: 24px; }
        .depth-2 { margin-left: 48px; }
        .depth-3 { margin-left: 72px; }
        .reply-btn { font-size: 0.75rem !important; padding: 1px 6px !important; margin-top: 3px !important; }
        .toggle-children { font-size: 0.8rem; cursor: pointer; }
        .comment-line-wrap { position: relative; }
        .comment-line { position: absolute; top: 0; bottom: -5px; left: 10px; border-left: 1.5px solid #d0d0d0; }
        .indent-arrow { margin-right: 4px; color: #777; font-size: 0.8rem; }
    </style>

    <div class="container" style="max-width: 900px;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <div class="text-muted small">커뮤니티</div>
                <h3 class="fw-bold m-0" th:text="${board.title}">게시글 제목</h3>
                <div class="text-muted small mt-2">
                    <span th:text="${board.username}">작성자</span> ·
                    <span th:text="${#temporals.format(board.createdAt,'yyyy-MM-dd HH:mm')}">2025-01-01</span> ·
                    <span th:text="|조회 ${board.viewCount}|">조회</span> ·
                    <span class="badge bg-primary" th:text="${board.category}">카테고리</span>
                </div>
            </div>
            <div th:if="${board.mine}" class="d-flex gap-2">
                <form th:action="@{/board/{id}/delete(id=${board.id})}"
                      method="post"
                      onsubmit="return confirm('정말 삭제하시겠어요?');">
                    <button class="btn btn-danger btn-sm">삭제</button>
                </form>
            </div>
        </div>

        <div th:if="${board.category.name() == 'PLAYER'}"
             class="card-box mb-4">
            <h6 class="fw-bold mb-2">추가 정보 (선수 모집)</h6>
            <div>포지션: <span th:text="${board.positionNeeded}"></span></div>
            <div>나이대: <span th:text="${board.ageRange}"></span></div>
            <div>실력: <span th:text="${board.skillLevel}"></span></div>
            <div th:if="${board.authorTeamId != null}" class="mt-2">
                <a th:href="@{/team/detail/{id}(id=${board.authorTeamId})}"
                   class="btn btn-outline-secondary btn-sm">
                    작성 팀 보기 (<span th:text="${board.authorTeamName}">team</span>)
                </a>
            </div>
        </div>

        <div th:if="${board.category.name() == 'TEAM'}"
             class="card-box mb-4">
            <h6 class="fw-bold mb-2">추가 정보 (팀 구함)</h6>
            <div>지역: <span th:text="${board.region}"></span></div>
            <div>포지션: <span th:text="${board.preferredPosition}"></span></div>
            <div>실력: <span th:text="${board.skillLevel}"></span></div>
        </div>

        <div class="card-box mb-4">
            <div class="content-box" th:utext="${board.content}"></div>
        </div>

        <div class="mb-4">
            <button id="likeBtn" class="btn btn-outline-danger">
                ❤️ 추천하기 <span id="likeCount">0</span>
            </button>
        </div>

        <div class="card-box">
            <div class="card-header">
                <span>댓글</span>
            </div>
            <div class="pt-2" th:each="comment : ${board.comments}">
                <th:block th:replace="~{this :: commentItem(comment=${comment}, depth=0)}"></th:block>
            </div>

            <form method="post" th:action="@{/board/{id}/comment(id=${board.id})}" class="mt-3">
                <textarea name="content" class="form-control mb-2" rows="3" placeholder="댓글을 입력해주세요."></textarea>
                <button class="btn btn-primary">댓글 등록</button>
            </form>
        </div>
    </div>

    <!-- 댓글 재귀 프래그먼트 -->
    <th:block th:fragment="commentItem(comment, depth)">
        <th:block th:if="${comment != null}" th:with="d=${depth > 3 ? 3 : depth}">
            <div class="comment-line-wrap">
                <div th:if="${d > 0}" class="comment-line"></div>
                <div class="comment-box" th:classappend="' depth-' + ${d}">
                    <span th:if="${d > 0}" class="indent-arrow">↳</span>
                    <span class="fw-semibold" th:text="${comment.username}">작성자</span>
                    <div class="mt-1" th:text="${comment.content}"></div>
                    <small class="text-muted" th:text="${#temporals.format(comment.createdAt,'yy-MM-dd HH:mm')}"></small>
                    <button class="btn btn-sm btn-outline-secondary mt-2 reply-btn">답글</button>
                    <form method="post"
                          th:action="@{/board/{id}/comment(id=${board.id})}"
                          class="reply-form d-none mt-2">
                        <input type="hidden" name="parentId" th:value="${comment.id}">
                        <textarea name="content" class="form-control mb-2" rows="2"></textarea>
                        <button class="btn btn-sm btn-primary">등록</button>
                    </form>
                </div>
            </div>

            <div th:if="${comment.totalChildrenCount > 0}"
                 class="children-toggle-wrapper"
                 th:style="'margin-left:' + ((d + 1) * 30) + 'px; margin-top:5px; margin-bottom:5px;'">
                <button type="button"
                        class="btn btn-link p-0 text-muted toggle-children"
                        th:data-target="'children-' + ${comment.id}">
                    <span th:text="'답글 ' + ${comment.totalChildrenCount} + '개 보기 ▾'"></span>
                </button>
            </div>

            <div th:id="'children-' + ${comment.id}"
                 class="children-box d-none"
                 th:style="'margin-left:' + ((d + 1) * 30) + 'px;'">
                <div th:each="child : ${comment.children}">
                    <th:block th:replace="~{this :: commentItem(comment=${child}, depth=${d + 1})}"></th:block>
                </div>
            </div>
        </th:block>
    </th:block>

    <script>
        document.addEventListener("click", function(e) {
            if (e.target.classList.contains("reply-btn")) {
                const form = e.target.nextElementSibling;
                if (form) form.classList.toggle("d-none");
            }
            const btn = e.target.closest(".toggle-children");
            if (btn) {
                const targetId = btn.getAttribute("data-target");
                const box = document.getElementById(targetId);
                if (!box) return;
                const hidden = box.classList.contains("d-none");
                box.classList.toggle("d-none");
                document.querySelectorAll(`.toggle-children[data-target="${targetId}"] span`)
                    .forEach(span => {
                        span.innerText = hidden
                            ? span.innerText.replace("▾", "▴")
                            : span.innerText.replace("▴", "▾");
                    });
            }
        });
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const boardId = [[${board.id}]];
            const likeBtn = document.getElementById("likeBtn");
            const likeCountSpan = document.getElementById("likeCount");

            function loadTodayLikes() {
                fetch(`/api/board/${boardId}/likes/today`)
                    .then(res => res.json())
                    .then(count => { likeCountSpan.textContent = count; });
            }
            loadTodayLikes();

            likeBtn.addEventListener("click", function() {
                fetch(`/api/board/${boardId}/like`, { method: "POST" })
                    .then(res => {
                        if (res.ok) {
                            loadTodayLikes();
                        } else {
                            alert("추천에 실패했습니다.");
                        }
                    });
            });
        });
    </script>
</div>
</html>
