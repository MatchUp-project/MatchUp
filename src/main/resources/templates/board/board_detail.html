<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>게시글 상세</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        /* --- 페이지 전체 스타일 --- */
        body {
            background: #fff;
            color: #000;
        }

        /* 게시글 본문 */
        .content-box {
            white-space: pre-line;
            font-size: 1.05rem;
            line-height: 1.6rem;
        }

        /* 댓글 박스 — 세로 간격 축소 */
        .comment-box {
            padding: 6px 0;              /* 기존 10px → 6px */
            border-bottom: 1px solid #ddd;  /* 조금 더 연하게 */
            font-size: 0.95rem;          /* 전체 약간 축소 */
        }

        /* depth 제한: 0~3 */
        .depth-0 { margin-left: 0; }
        .depth-1 { margin-left: 24px; }   /* 30 → 24 로 살짝 축소 */
        .depth-2 { margin-left: 48px; }
        .depth-3 { margin-left: 72px; }   /* 전체적으로 좌측 공간 줄임 */

        /* 세로 라인 */
        .comment-line-wrap {
            position: relative;
        }
        .comment-line {
            position: absolute;
            top: 0;
            bottom: -5px;
            left: 10px;
            border-left: 1.5px solid #aaa; /* 너무 진하지 않게 */
        }

        /* ㄴ 표시 */
        .indent-arrow {
            margin-right: 4px;
            color: #777;
            font-size: 0.8rem;           /* 줄임 */
        }

        /* 작성자 닉네임 */
        .comment-box .fw-semibold {
            font-size: 0.95rem;          /* 기본보다 약간 축소 */
        }

        /* 댓글 본문 */
        .comment-box div {
            line-height: 1.4rem;         /* 줄 간격 ↓ */
        }

        /* 시간 표시 */
        .comment-box small {
            font-size: 0.78rem;
        }

        /* 답글 버튼 */
        .reply-btn {
            font-size: 0.75rem !important;
            padding: 1px 6px !important;
            margin-top: 3px !important;
        }

        /* 답글 보기/숨기기 버튼 */
        .toggle-children {
            font-size: 0.8rem;
            cursor: pointer;
        }

        /* '답글 n개 보기' 들여쓰기 위치 통일 */
        .children-toggle-wrapper {
            margin-top: 4px;
            margin-bottom: 4px;
        }



    </style>
</head>

<body>

<!-- 상단 유틸 바 -->
<div class="bg-dark text-white small py-1">
    <div class="container d-flex justify-content-end gap-3">
        <a href="/" class="link-light text-decoration-none">홈</a>
        <a href="/profile" class="link-light text-decoration-none">내 정보</a>
        <a href="/logout" class="link-light text-decoration-none">로그아웃</a>
    </div>
</div>

<!-- ===== 헤더 + 검색 + 상단 메뉴 ===== -->
<header class="border-bottom">
    <div class="container py-3">

        <!-- 1줄 : 로고 + 검색 -->
        <div class="d-flex align-items-center justify-content-between gap-3">
            <!-- 로고 -->
            <a class="navbar-brand fw-bold fs-3 text-primary m-0" href="/">Match-Up</a>

            <!-- 검색 -->
            <form class="d-flex flex-grow-1 mx-4" role="search">
                <input class="form-control form-control-lg rounded-start-pill"
                       type="search" placeholder="팀, 구장, 지역 검색">
                <button class="btn btn-primary btn-lg rounded-end-pill px-4" type="submit">
                    <i class="bi bi-search"></i>
                </button>
            </form>

            <!-- (필요하면 우측에 버튼 더 둘 수 있음) -->
        </div>

        <!-- 2줄 : 상단 메뉴바 -->
        <nav class="mt-3">
            <ul class="nav main-nav border-top pt-2">

                <!-- 팀 (드롭다운) -->
                <li class="nav-item dropdown">
                    <a class="nav-link px-4 fw-semibold main-nav-link dropdown-toggle"
                       href="#" id="teamMenu"
                       role="button"
                       data-bs-toggle="dropdown"
                       aria-expanded="false">
                        팀
                    </a>
                    <ul class="dropdown-menu" aria-labelledby="teamMenu">
                        <li><a class="dropdown-item" href="/team/board">팀 게시판</a></li>
                        <li><a class="dropdown-item" href="/team/members">팀 멤버</a></li>
                        <li><a class="dropdown-item" href="/team/schedule">일정표</a></li>
                        <li><a class="dropdown-item" href="/team/records">경기 기록</a></li>
                    </ul>
                </li>

                <!-- 커뮤니티 -->
                <li class="nav-item">
                    <a class="nav-link px-4 fw-semibold main-nav-link" href="/board/list?category=FREE">
                        커뮤니티
                    </a>
                </li>

                <!-- 매치 신청 -->
                <li class="nav-item">
                    <a class="nav-link px-4 fw-semibold main-nav-link" href="/match/apply">
                        매치 신청
                    </a>
                </li>

            </ul>
        </nav>
    </div>
</header>


<div class="container py-5" style="max-width: 900px;">

    <!-- 제목 -->
    <h2 class="fw-bold mb-3" th:text="${board.title}"></h2>

    <!-- 작성자 정보 -->
    <div class="text-muted mb-4">
        <span th:text="${board.username}"></span> ·
        <span th:text="${#temporals.format(board.createdAt,'yyyy-MM-dd HH:mm')}"></span> ·
        <span th:text="|조회 ${board.viewCount}|"></span> ·
        <span class="badge bg-primary" th:text="${board.category}"></span>
    </div>

    <!-- PLAYER 상세 -->
    <div th:if="${board.category.name() == 'PLAYER'}"
         class="p-3 mb-4 border rounded bg-light">
        <h6 class="fw-bold mb-2">추가 정보</h6>
        <div>포지션: <span th:text="${board.positionNeeded}"></span></div>
        <div>나이대: <span th:text="${board.ageRange}"></span></div>
        <div>실력: <span th:text="${board.skillLevel}"></span></div>
    </div>

    <!-- TEAM 상세 -->
    <div th:if="${board.category.name() == 'TEAM'}"
         class="p-3 mb-4 border rounded bg-light">
        <h6 class="fw-bold mb-2">추가 정보</h6>
        <div>지역: <span th:text="${board.region}"></span></div>
        <div>포지션: <span th:text="${board.preferredPosition}"></span></div>
        <div>실력: <span th:text="${board.skillLevel}"></span></div>
    </div>

    <!-- 본문 -->
    <div class="content-box mb-5" th:utext="${board.content}"></div>


    <!-- 추천 버튼 -->
    <div class="mb-5">
        <button class="btn btn-outline-danger">❤️ 추천하기</button>
    </div>


    <!-- ============================= -->
    <!--         댓글 최상위          -->
    <!-- ============================= -->
    <h5 class="fw-bold mb-3">댓글</h5>

    <div th:each="comment : ${board.comments}">
        <th:block th:replace="~{this :: commentItem(comment=${comment}, depth=0)}"></th:block>
    </div>


    <!-- ============================= -->
    <!--     댓글 Fragment (재귀)     -->
    <!-- ============================= -->
    <th:block th:fragment="commentItem(comment, depth)">

        <th:block th:if="${comment != null}"
                  th:with="d=${depth > 3 ? 3 : depth}">

            <!-- 댓글 1개 -->
            <div class="comment-line-wrap">

                <!-- 세로 라인 (depth ≥ 1) -->
                <div th:if="${d > 0}" class="comment-line"></div>

                <div class="comment-box" th:classappend="' depth-' + ${d}">

                    <!-- ㄴ 표시 -->
                    <span th:if="${d > 0}" class="indent-arrow">ㄴ</span>

                    <!-- 작성자 -->
                    <span class="fw-semibold" th:text="${comment.username}"></span>

                    <!-- 내용 -->
                    <div th:text="${comment.content}" class="mt-1"></div>

                    <!-- 시간 -->
                    <small class="text-muted"
                           th:text="${#temporals.format(comment.createdAt,'yy-MM-dd HH:mm')}"></small>

                    <!-- 답글 버튼 -->
                    <button class="btn btn-sm btn-outline-secondary mt-2 reply-btn">답글</button>

                    <!-- 답글 입력 폼 -->
                    <form method="post"
                          th:action="@{/board/{id}/comment(id=${board.id})}"
                          class="reply-form d-none mt-2">

                        <input type="hidden" name="parentId" th:value="${comment.id}">
                        <textarea name="content" class="form-control mb-2" rows="2"></textarea>
                        <button class="btn btn-sm btn-primary">등록</button>
                    </form>
                </div>
            </div>

            <!-- =============================== -->
            <!-- ✨ 답글 n개 보기 버튼 (depth 기반 margin-left 적용) -->
            <div th:if="${comment.totalChildrenCount > 0}"
                 th:style="'margin-left:' + __${(d + 1) * 30}__ + 'px; margin-top:5px; margin-bottom:5px;'">

            <button type="button"
                        class="btn btn-link p-0 text-muted toggle-children"
                        th:data-target="'children-' + ${comment.id}">
                    <span th:text="'답글 ' + ${comment.totalChildrenCount} + '개 보기 ▼'"></span>
                </button>

            </div>


            <!-- =============================== -->
            <!-- ✨ 자식 댓글 영역 (숨기기 버튼 없음) -->
            <!-- =============================== -->
            <div th:id="'children-' + ${comment.id}"
                 class="children-box d-none"
                 th:style="'margin-left:' + __${(d + 1) * 30}__ + 'px;'">


            <div th:each="child : ${comment.children}">
                    <th:block th:replace="~{this :: commentItem(comment=${child}, depth=${d + 1})}"></th:block>
                </div>

            </div>

        </th:block>
    </th:block>



    <!-- 새 댓글 -->
    <form method="post" th:action="@{/board/{id}/comment(id=${board.id})}" class="mt-4">
        <textarea name="content" class="form-control mb-2" rows="3"
                  placeholder="댓글을 입력하세요"></textarea>
        <button class="btn btn-primary">댓글 등록</button>
    </form>

</div>

<script>
    document.addEventListener("click", function(e) {

    // 답글 입력창 on/off
    if (e.target.classList.contains("reply-btn")) {
        const form = e.target.nextElementSibling;
        if (form) form.classList.toggle("d-none");
    }

    // 답글 보기/숨기기
    const btn = e.target.closest(".toggle-children");
    if (btn) {
        const targetId = btn.getAttribute("data-target");
        const box = document.getElementById(targetId);
        if (!box) return;

        const hidden = box.classList.contains("d-none");

        box.classList.toggle("d-none");

        document.querySelectorAll(
            `.toggle-children[data-target="${targetId}"] span`
        ).forEach(span => {
            span.innerText = hidden
                ? span.innerText.replace("보기 ▼", "숨기기 ▲")
                : span.innerText.replace("숨기기 ▲", "보기 ▼");
            });
        }
    });

</script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
