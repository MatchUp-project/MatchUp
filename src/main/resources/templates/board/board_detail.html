<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>게시글 상세</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        /* depth별 들여쓰기 */
        .depth-0 { margin-left: 0; }
        .depth-1 { margin-left: 25px; border-left: 2px solid #ddd; padding-left: 15px; }
        .depth-2 { margin-left: 50px; border-left: 2px solid #ddd; padding-left: 15px; }
        .depth-3 { margin-left: 75px; border-left: 2px solid #ddd; padding-left: 15px; }
        .depth-4 { margin-left: 100px; border-left: 2px solid #ddd; padding-left: 15px; }

        .comment-box {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
    </style>
</head>

<body>

<!-- 상단바 -->
<div class="bg-dark text-white small py-1">
    <div class="container d-flex justify-content-end gap-3">
        <a href="/" class="link-light text-decoration-none">홈</a>
        <a href="/profile" class="link-light text-decoration-none">내 정보</a>
        <a href="/logout" class="link-light text-decoration-none">로그아웃</a>
    </div>
</div>

<div class="container py-5">

    <!-- 제목 -->
    <h2 class="fw-bold mb-3" th:text="${board.title}"></h2>

    <!-- 작성자 정보 -->
    <div class="text-muted mb-4">
        <span th:text="${board.username}"></span> ·
        <span th:text="${#temporals.format(board.createdAt,'yyyy-MM-dd HH:mm')}"></span> ·
        <span th:text="|조회 ${board.viewCount}|"></span> ·
        <span class="badge bg-primary" th:text="${board.category}"></span>
    </div>

    <!-- PLAYER -->
    <div th:if="${board.category.name() == 'PLAYER'}"
         class="p-3 mb-4 border rounded bg-light">
        <h6 class="fw-bold mb-2">추가 정보</h6>
        <div>포지션: <span th:text="${board.positionNeeded}"></span></div>
        <div>나이대: <span th:text="${board.ageRange}"></span></div>
        <div>실력: <span th:text="${board.skillLevel}"></span></div>
    </div>

    <!-- TEAM -->
    <div th:if="${board.category.name() == 'TEAM'}"
         class="p-3 mb-4 border rounded bg-light">
        <h6 class="fw-bold mb-2">추가 정보</h6>
        <div>지역: <span th:text="${board.region}"></span></div>
        <div>포지션: <span th:text="${board.preferredPosition}"></span></div>
        <div>실력: <span th:text="${board.skillLevel}"></span></div>
    </div>

    <!-- 본문 -->
    <div class="mb-5" th:utext="${board.content}"></div>

    <!-- 추천 버튼 -->
    <div class="mb-5">
        <button class="btn btn-outline-danger">❤️ 추천하기</button>
    </div>

    <!-- 댓글 -->
    <h5 class="fw-bold mb-3">댓글</h5>

    <!-- 최상위 댓글 -->
    <div th:each="comment : ${board.comments}">
        <th:block th:replace="~{this :: commentItem(comment=${comment}, depth=0)}"></th:block>
    </div>

    <!-- 댓글 Fragment -->
    <th:block th:fragment="commentItem(comment, depth)">

        <!-- null-safe -->
        <th:block th:if="${comment != null}">

            <div class="comment-box"
                 th:classappend="' depth-' + ${depth}">

                <div class="fw-semibold" th:text="${comment.username}"></div>
                <div th:text="${comment.content}"></div>

                <small class="text-muted"
                       th:text="${#temporals.format(comment.createdAt,'yy-MM-dd HH:mm')}"></small>

                <button class="btn btn-sm btn-outline-secondary mt-2 reply-btn">답글</button>

                <!-- 답글 입력 폼 -->
                <form method="post"
                      th:action="@{/board/{id}/comment(id=${board.id})}"
                      class="reply-form d-none mt-2">

                    <input type="hidden" name="parentId" th:value="${comment.id}">
                    <textarea name="content" class="form-control mb-2" rows="2"></textarea>
                    <button class="btn btn-sm btn-primary">등록</button>
                </form>
            </div>

            <!-- 자식 댓글 재귀 호출 -->
            <div th:each="child : ${comment.children}">
                <th:block th:replace="~{this :: commentItem(comment=${child}, depth=${depth + 1})}"></th:block>
            </div>

        </th:block>

    </th:block>

    <!-- 새 댓글 입력 -->
    <form method="post" th:action="@{/board/{id}/comment(id=${board.id})}" class="mt-4">
        <textarea name="content" class="form-control mb-2" rows="3"
                  placeholder="댓글을 입력하세요"></textarea>
        <button class="btn btn-primary">댓글 등록</button>
    </form>

</div>

<script>
    document.addEventListener("click", function(e) {
        if (e.target.classList.contains("reply-btn")) {
            const form = e.target.nextElementSibling;
            form.classList.toggle("d-none");
        }
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
