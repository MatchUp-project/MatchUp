<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      th:replace="fragments/layout :: layout(~{::content})">
<div th:fragment="content">
    <style>
        .table-title-ellipsis {
            display: block;
            width: 100%;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        .table-extra-col {
            max-width: 260px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        table { table-layout: fixed; }
        aside.col-md-3, section.col-md-9 { align-self: flex-start; }
        .btn-write { height: 38px; padding: 0 16px; font-size: 0.9rem; display: inline-flex; align-items: center; justify-content: center; white-space: nowrap; }
        .list-group-item.active {
            background: #e6342a;
            border-color: #e6342a;
        }
        .list-group-item.active,
        .list-group-item.active:hover { color: #fff; }
    </style>

    <div class="container-fluid px-0">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <div class="text-muted small">커뮤니티</div>
                <h4 class="fw-bold m-0" th:text="${categoryName != null ? categoryName : '통합 게시판'}">통합 게시판</h4>
            </div>
            <div class="d-flex align-items-center gap-2">
                <select class="form-select form-select-sm"
                        th:data-category="${category}"
                        th:data-region="${region}"
                        onchange="changeSort(this)">
                    <option value="latest" th:selected="${sort == 'latest'}">최신순</option>
                    <option value="today"  th:selected="${sort == 'today'}">오늘 인기글</option>
                    <option value="week"   th:selected="${sort == 'week'}">주간 인기글</option>
                    <option value="month"  th:selected="${sort == 'month'}">월간 인기글</option>
                </select>

                <select class="form-select form-select-sm"
                        th:if="${category != null and (category.name() == 'PLAYER' or category.name() == 'TEAM')}"
                        id="regionSelect"
                        onchange="changeRegion(this)">
                    <option value="" th:selected="${region == null or #strings.isEmpty(region)}">전체 지역</option>
                    <option value="SEOUL" th:selected="${region == 'SEOUL'}">서울</option>
                    <option value="GYEONGGI" th:selected="${region == 'GYEONGGI'}">경기</option>
                    <option value="INCHEON" th:selected="${region == 'INCHEON'}">인천</option>
                    <option value="BUSAN" th:selected="${region == 'BUSAN'}">부산</option>
                    <option value="DAEGU" th:selected="${region == 'DAEGU'}">대구</option>
                    <option value="DAEJEON" th:selected="${region == 'DAEJEON'}">대전</option>
                    <option value="GWANGJU" th:selected="${region == 'GWANGJU'}">광주</option>
                    <option value="ULSAN" th:selected="${region == 'ULSAN'}">울산</option>
                    <option value="SEJONG" th:selected="${region == 'SEJONG'}">세종</option>
                    <option value="GANGWON" th:selected="${region == 'GANGWON'}">강원</option>
                    <option value="CHUNGBUK" th:selected="${region == 'CHUNGBUK'}">충북</option>
                    <option value="CHUNGNAM" th:selected="${region == 'CHUNGNAM'}">충남</option>
                    <option value="JEONBUK" th:selected="${region == 'JEONBUK'}">전북</option>
                    <option value="JEONNAM" th:selected="${region == 'JEONNAM'}">전남</option>
                    <option value="GYEONGBUK" th:selected="${region == 'GYEONGBUK'}">경북</option>
                    <option value="GYEONGNAM" th:selected="${region == 'GYEONGNAM'}">경남</option>
                    <option value="JEJU" th:selected="${region == 'JEJU'}">제주</option>
                </select>

                <a th:href="@{/board/write(category=${category})}" class="btn btn-primary btn-write">글쓰기</a>
            </div>
        </div>

        <div class="row g-4">
            <aside class="col-md-3">
                <div class="list-group shadow-sm">
                    <a th:href="@{/board/list(category='FREE')}"
                       class="list-group-item list-group-item-action"
                       th:classappend="${category?.name() == 'FREE'} ? ' active'">
                        자유게시판
                    </a>
                    <a th:href="@{/board/list(category='PLAYER')}"
                       class="list-group-item list-group-item-action"
                       th:classappend="${category?.name() == 'PLAYER'} ? ' active'">
                        선수 모집
                    </a>
                    <a th:href="@{/board/list(category='TEAM')}"
                       class="list-group-item list-group-item-action"
                       th:classappend="${category?.name() == 'TEAM'} ? ' active'">
                        팀 구함
                    </a>
                </div>
            </aside>

            <section class="col-md-9">
                <div class="card-box">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                            <tr>
                                <th style="width:80px;">번호</th>
                                <th>제목</th>
                                <th style="width:230px;">추가 정보</th>
                                <th style="width:150px;">작성자</th>
                                <th style="width:120px;">작성일</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="post, stat : ${boards}">
                                <td th:text="${stat.count}"></td>
                                <td>
                                    <a th:href="@{/board/{id}(id=${post.id})}"
                                       th:text="${post.title}"
                                       class="text-decoration-none fw-semibold table-title-ellipsis"></a>
                                </td>
                                <td class="table-extra-col">
                                    <span th:if="${post.category?.name() == 'FREE'}">-</span>
                                    <span th:if="${post.category?.name() == 'PLAYER'}"
                                          th:text="|포지션: ${post.positionNeeded} / 나이: ${post.ageRange} / 실력: ${post.skillLevel}|"></span>
                                    <div th:if="${post.category?.name() == 'PLAYER' and post.authorTeamId != null}"
                                         class="small mt-1">
                                        <a th:href="@{/team/detail/{id}(id=${post.authorTeamId})}"
                                           class="text-decoration-none">
                                            작성 팀: <span th:text="${post.authorTeamName}">team</span>
                                        </a>
                                    </div>
                                    <span th:if="${post.category?.name() == 'TEAM'}"
                                          th:text="|지역: ${post.region} / 포지션: ${post.preferredPosition} / 실력: ${post.skillLevel}|"></span>
                                </td>
                                <td th:text="${post.username}"></td>
                                <td th:text="${#temporals.format(post.createdAt, 'yy-MM-dd')}"></td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(boards)}">
                                <td colspan="5" class="text-center text-muted py-4">등록된 게시글이 없습니다.</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        function changeSort(selectEl) {
            const category = selectEl.dataset.category || '';
            const sort = selectEl.value;
            const region = selectEl.dataset.region || '';
            if (!category) {
                const q = region ? `?sort=${sort}&region=${encodeURIComponent(region)}` : `?sort=${sort}`;
                location.href = `/board/list${q}`;
            } else {
                const base = `/board/list?category=${category}&sort=${sort}`;
                const q = region ? `${base}&region=${encodeURIComponent(region)}` : base;
                location.href = q;
            }
        }
        function changeRegion(selectEl) {
            const category = document.querySelector('[data-category]')?.dataset.category || '';
            const sort = document.querySelector('[data-category]')?.value || 'latest';
            const region = selectEl.value;
            let url = '/board/list';
            const params = [];
            if (category) params.push(`category=${category}`);
            if (sort) params.push(`sort=${sort}`);
            if (region) params.push(`region=${encodeURIComponent(region)}`);
            if (params.length > 0) url += '?' + params.join('&');
            location.href = url;
        }
    </script>
</div>
</html>
