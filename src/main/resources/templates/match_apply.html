<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>매치 신청 | Match-Up</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/styles.css}">
    <style>
        .match-card.matched {
            opacity: 0.4;
        }
    </style>
</head>
<body>

<div class="container mt-4">
    <h3 class="mb-4">매치 신청</h3>

    <!-- 팀이 없을 때 -->
    <div th:if="${noTeam}">
        <div class="alert alert-warning">
            사용자가 속한 팀이 없습니다.
        </div>
    </div>

    <!-- 팀이 있을 때 -->
    <div th:unless="${noTeam}">
        <!-- 내 팀 정보 -->
        <div class="mb-4">
            <h5>내 팀:
                <span th:text="${team != null ? team.name : '팀 이름'}">팀 이름</span>
            </h5>
        </div>

        <!-- 매치 등록 폼 -->
        <div class="card mb-4">
            <div class="card-header">새로운 매치 등록</div>
            <div class="card-body">
                <form th:action="@{/match/create}" method="post" th:object="${matchCreateForm}">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">팀 이름</label>
                            <input type="text" class="form-control"
                                   th:value="${team != null ? team.name : '팀 이름'}" readonly>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">인원 수</label>
                            <input type="number" class="form-control"
                                   th:field="*{playerCount}" min="1" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">경기장 위치</label>
                            <input type="text" class="form-control"
                                   th:field="*{location}" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">날짜</label>
                            <input type="date" class="form-control"
                                   th:field="*{date}" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">시간</label>
                            <input type="time" class="form-control"
                                   th:field="*{time}" required>
                        </div>
                    </div>
                    <div class="mt-3 text-end">
                        <button type="submit" class="btn btn-primary">매치 등록</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 신청 가능 매치 목록 -->
        <h5 class="mb-3">신청 가능 매치 목록</h5>

        <div th:if="${#lists.isEmpty(matchPosts)}" class="text-muted mb-3">
            현재 등록된 매치가 없습니다.
        </div>

        <div class="row g-3" th:each="post : ${matchPosts}">
            <div class="col-12">
                <div class="card match-card"
                     th:classappend="${post.status == 'MATCHED'} ? ' matched' : ''">
                    <div class="card-body d-flex justify-content-between align-items-center">

                        <!-- 왼쪽: 매치 정보 -->
                        <div>
                            <div class="mb-1">
                                <strong th:text="${post.team.name}">팀 이름</strong>
                                <span class="text-muted ms-2">
                                    인원수: <span th:text="${post.playerCount}">0</span>명
                                </span>
                            </div>
                            <div class="small text-muted">
                                장소:
                                <span th:text="${post.location}">장소</span><br>
                                일시:
                                <span th:text="${#temporals.format(post.matchDatetime, 'yyyy-MM-dd HH:mm')}">
                                    2025-03-28 09:40
                                </span>
                            </div>
                        </div>

                        <!-- 오른쪽: 상태 / 버튼 -->
                        <div class="text-end">

                            <!-- 매치가 이미 완료된 경우 -->
                            <div th:if="${post.status == 'MATCHED'}"
                                 class="text-danger fw-semibold mb-2">
                                이미 매치가 완료됐습니다
                            </div>

                            <!-- 내가 개설한 매치 -->
                            <div th:if="${post.createdBy != null and post.createdBy.id == currentUser.id}">
                                <span class="badge bg-secondary">내가 등록한 매치</span>
                            </div>

                            <!-- 내가 신청한 매치 -->
                            <div th:if="${post.status == 'OPEN'
                                         and post.createdBy != null
                                         and post.createdBy.id != currentUser.id
                                         and #lists.contains(requestedMatchIds, post.id)}"
                                 class="text-primary fw-semibold">
                                매치 신청 완료됐습니다
                            </div>

                            <!-- 신청 가능 (아직 신청 안 했고, 내가 만든 글도 아님) -->
                            <div th:if="${post.status == 'OPEN'
                                         and (post.createdBy == null or post.createdBy.id != currentUser.id)
                                         and !#lists.contains(requestedMatchIds, post.id)}">
                                <form th:action="@{'/match/' + ${post.id} + '/request'}"
                                      method="post">
                                    <button type="submit" class="btn btn-outline-primary">
                                        매치 신청
                                    </button>
                                </form>
                            </div>

                            <!-- ⚠ 여기에는 더 이상 '경기 기록 작성' 버튼 없음 -->

                        </div>

                    </div> <!-- card-body -->
                </div>
            </div>
        </div> <!-- row -->
    </div> <!-- /팀 있을 때 -->
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
