<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>팀 일정</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 900px; margin: 0 auto; }
        a { text-decoration: none; color: #007bff; }
        h1 { margin-bottom: 10px; }
        .event-card {
            background: #ffffff; border-radius: 8px; padding: 12px 16px;
            margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .event-title { font-weight: bold; font-size: 17px; }
        .event-meta { font-size: 13px; color: #777; margin-top: 4px; }
        .form-box {
            background: #ffffff; border-radius: 8px; padding: 16px;
            margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        label { display: block; margin-top: 8px; font-size: 14px; }
        input[type="text"], input[type="datetime-local"], select {
            width: 100%; box-sizing: border-box; padding: 8px; margin-top: 4px;
        }
        button {
            margin-top: 12px; padding: 8px 16px; border: none; border-radius: 4px;
            background: #4CAF50; color: #fff; cursor: pointer;
        }
        button:disabled { background: #aaa; }
        .error { color: red; margin-top: 6px; }
        .empty { color: #666; margin-top: 10px; }
    </style>
</head>
<body>
<div class="container">
    <a href="/">← 팀 목록으로</a>
    <h1 id="title">팀 일정</h1>

    <div class="form-box">
        <h2>새 일정 추가</h2>
        <label>
            제목
            <input type="text" id="eventTitle" placeholder="예: 주말 연습 경기">
        </label>
        <label>
            시작 시간
            <input type="datetime-local" id="startAt">
        </label>
        <label>
            종료 시간
            <input type="datetime-local" id="endAt">
        </label>
        <label>
            장소
            <input type="text" id="place" placeholder="예: 잠실야구장">
        </label>
        <label>
            유형
            <select id="eventType">
                <option value="TRAINING">훈련(TRAINING)</option>
                <option value="MATCH">경기(MATCH)</option>
                <option value="ETC" selected>기타(ETC)</option>
            </select>
        </label>

        <button id="addBtn">일정 추가</button>
        <div class="error" id="errorMsg"></div>
    </div>

    <h2>일정 목록</h2>
    <div id="eventContainer"></div>
</div>

<script>
    const params = new URLSearchParams(location.search);
    const teamId = Number(params.get('teamId'));
    const teamName = params.get('teamName') || '팀';

    document.getElementById('title').textContent = teamName + ' 일정';

    const EVENT_API = '/api/events';

    function formatDateTime(str) {
        if (!str) return '';
        return str.replace('T', ' ');
    }

    async function loadEvents() {
        const container = document.getElementById('eventContainer');
        container.innerHTML = '불러오는 중...';

        try {
            const res = await fetch(EVENT_API + '?teamId=' + teamId);
            if (!res.ok) throw new Error('서버 오류: ' + res.status);
            const data = await res.json();

            if (data.length === 0) {
                container.innerHTML = '<div class="empty">등록된 일정이 없습니다.</div>';
                return;
            }

            container.innerHTML = '';
            data.forEach(ev => {
                const div = document.createElement('div');
                div.className = 'event-card';
                div.innerHTML = `
                    <div class="event-title">${ev.title || '(제목 없음)'}</div>
                    <div class="event-meta">
                        유형: ${ev.eventType} /
                        시작: ${ev.startAt ? ev.startAt.replace('T',' ') : '-'} /
                        종료: ${ev.endAt ? ev.endAt.replace('T',' ') : '-'} /
                        장소: ${ev.place || '-'}
                    </div>
                `;
                container.appendChild(div);
            });

        } catch (e) {
            container.innerHTML = '<div class="error">일정을 불러오는 중 오류가 발생했습니다.</div>';
            console.error(e);
        }
    }

    async function addEvent() {
        const titleEl = document.getElementById('eventTitle');
        const startEl = document.getElementById('startAt');
        const endEl = document.getElementById('endAt');
        const placeEl = document.getElementById('place');
        const typeEl = document.getElementById('eventType');
        const errorMsg = document.getElementById('errorMsg');
        const btn = document.getElementById('addBtn');

        errorMsg.textContent = '';

        if (!startEl.value) {
            errorMsg.textContent = '시작 시간은 필수입니다.';
            return;
        }

        const body = {
            teamId: teamId,
            title: titleEl.value.trim(),
            startAt: startEl.value ? startEl.value : null,
            endAt: endEl.value ? endEl.value : null,
            place: placeEl.value.trim(),
            eventType: typeEl.value
        };

        btn.disabled = true;

        try {
            const res = await fetch(EVENT_API, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            if (!res.ok) {
                const txt = await res.text();
                throw new Error('추가 실패: ' + txt);
            }

            titleEl.value = '';
            startEl.value = '';
            endEl.value = '';
            placeEl.value = '';
            typeEl.value = 'ETC';

            await loadEvents();

        } catch (e) {
            errorMsg.textContent = '일정 추가 중 오류: ' + e.message;
            console.error(e);
        } finally {
            btn.disabled = false;
        }
    }

    document.getElementById('addBtn').addEventListener('click', addEvent);
    window.addEventListener('load', loadEvents);
</script>
</body>
</html>
