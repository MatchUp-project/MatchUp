<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>팀 게시판</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 900px; margin: 0 auto; }
        a { text-decoration: none; color: #007bff; }
        h1 { margin-bottom: 10px; }
        .post-card {
            background: #ffffff; border-radius: 8px; padding: 12px 16px;
            margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .post-title { font-weight: bold; font-size: 17px; }
        .post-meta { font-size: 12px; color: #777; margin-top: 4px; }
        .post-content { margin-top: 6px; font-size: 14px; white-space: pre-wrap; }
        .form-box {
            background: #ffffff; border-radius: 8px; padding: 16px;
            margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        label { display: block; margin-top: 8px; font-size: 14px; }
        input[type="text"], textarea {
            width: 100%; box-sizing: border-box; padding: 8px; margin-top: 4px;
        }
        button {
            margin-top: 12px; padding: 8px 16px; border: none; border-radius: 4px;
            background: #4CAF50; color: #fff; cursor: pointer;
        }
        button:disabled { background: #aaa; }
        .error { color: red; margin-top: 6px; }
        .empty { color: #666; margin-top: 10px; }
    </style>
</head>
<body>
<div class="container">
    <a href="/">← 팀 목록으로</a>
    <h1 id="boardTitle">팀 게시판</h1>

    <div class="form-box">
        <h2>새 글 쓰기</h2>
        <label>
            제목
            <input type="text" id="title">
        </label>
        <label>
            내용
            <textarea id="content" rows="4"></textarea>
        </label>
        <button id="writeBtn">작성</button>
        <div class="error" id="errorMsg"></div>
    </div>

    <h2>게시글 목록</h2>
    <div id="postContainer"></div>
</div>

<script>
    const params = new URLSearchParams(location.search);
    const teamId = Number(params.get('teamId'));
    const teamName = params.get('teamName') || '팀';

    document.getElementById('boardTitle').textContent = teamName + ' 게시판';

    const POST_API = '/api/posts';

    async function loadPosts() {
        const container = document.getElementById('postContainer');
        container.innerHTML = '불러오는 중...';

        try {
            const res = await fetch(POST_API + '?teamId=' + teamId);
            if (!res.ok) throw new Error('서버 오류: ' + res.status);
            const data = await res.json();

            if (data.length === 0) {
                container.innerHTML = '<div class="empty">첫 글을 남겨보세요!</div>';
                return;
            }

            container.innerHTML = '';
            data.forEach(post => {
                const div = document.createElement('div');
                div.className = 'post-card';
                div.innerHTML = `
                    <div class="post-title">${post.title}</div>
                    <div class="post-meta">
                        글번호: ${post.id} / 작성자 ID: ${post.authorId} / 작성일: ${post.createdAt}
                    </div>
                    <div class="post-content">${post.content ?? ''}</div>
                `;
                container.appendChild(div);
            });

        } catch (e) {
            container.innerHTML = '<div class="error">게시글을 불러오는 중 오류가 발생했습니다.</div>';
            console.error(e);
        }
    }

    async function writePost() {
        const titleEl = document.getElementById('title');
        const contentEl = document.getElementById('content');
        const errorMsg = document.getElementById('errorMsg');
        const btn = document.getElementById('writeBtn');

        errorMsg.textContent = '';

        if (!titleEl.value.trim()) {
            errorMsg.textContent = '제목은 필수입니다.';
            return;
        }

        const body = {
            teamId: teamId,
            authorId: 1,  // 나중에 로그인 붙이면 현재 사용자 ID로 변경
            title: titleEl.value.trim(),
            content: contentEl.value.trim()
        };

        btn.disabled = true;

        try {
            const res = await fetch(POST_API, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            if (!res.ok) {
                const txt = await res.text();
                throw new Error('작성 실패: ' + txt);
            }

            titleEl.value = '';
            contentEl.value = '';

            await loadPosts();

        } catch (e) {
            errorMsg.textContent = '글 작성 중 오류: ' + e.message;
            console.error(e);
        } finally {
            btn.disabled = false;
        }
    }

    document.getElementById('writeBtn').addEventListener('click', writePost);
    window.addEventListener('load', loadPosts);
</script>
</body>
</html>
