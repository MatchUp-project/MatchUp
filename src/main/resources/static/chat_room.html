<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>채팅방</title>
    <style>
        body { font-family: Arial; background:#f5f5f5; padding:20px; }
        .container { max-width:900px; margin:auto; }
        .msg-box {
            background:white; padding:10px; margin:6px 0; border-radius:6px;
            box-shadow:0 1px 2px rgba(0,0,0,0.1);
        }
        .sender { font-size:12px; color:#888; }
        .input-box {
            position:fixed; bottom:0; left:0; right:0;
            background:white; padding:10px; box-shadow:0 -2px 4px rgba(0,0,0,0.1);
            display:flex; gap:8px;
        }
        .input-box input { flex:1; padding:8px; }
        .input-box button { padding:8px 16px; }
    </style>
</head>
<body>
<div class="container">
    <a href="javascript:history.back()">← 뒤로</a>
    <h1 id="title">채팅방</h1>

    <div id="msgContainer">불러오는 중...</div>
</div>

<div class="input-box">
    <input type="number" id="senderId" placeholder="보내는 사람 ID(users.id)">
    <input type="text" id="message" placeholder="메시지를 입력하세요">
    <button onclick="sendMsg()">전송</button>
</div>

<script>
    const params = new URLSearchParams(location.search);
    const roomId = Number(params.get("roomId"));
    const teamName = params.get("teamName");

    document.getElementById("title").textContent = teamName + " 채팅방";

    async function loadMessages() {
        const box = document.getElementById("msgContainer");
        const res = await fetch(`/api/chat/messages?roomId=${roomId}`);
        const data = await res.json();

        if (data.length === 0) {
            box.innerHTML = "메시지가 없습니다.";
            return;
        }

        box.innerHTML = "";
        data.forEach(msg => {
            const div = document.createElement("div");
            div.className = "msg-box";
            div.innerHTML = `
                <div class="sender">ID ${msg.senderId} | ${msg.sentAt.replace("T"," ")}</div>
                <div>${msg.message}</div>
            `;
            box.appendChild(div);
        });

        window.scrollTo(0, document.body.scrollHeight);
    }

    async function sendMsg() {
        const senderId = Number(document.getElementById("senderId").value);
        const message = document.getElementById("message").value.trim();

        if (!senderId || !message) return;

        const res = await fetch("/api/chat/messages", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ roomId, senderId, message })
        });

        if (!res.ok) {
            alert("오류: " + await res.text());
            return;
        }

        document.getElementById("message").value = "";
        loadMessages();
    }

    // 처음 로딩 + 3초마다 자동 새로고침
    loadMessages();
    setInterval(loadMessages, 3000);
</script>
</body>
</html>
