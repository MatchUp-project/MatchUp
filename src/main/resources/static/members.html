<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>팀원 관리</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 900px; margin: 0 auto; }
        a { text-decoration: none; color: #007bff; }
        h1 { margin-bottom: 10px; }
        .member-card {
            background: #ffffff; border-radius: 8px; padding: 10px 14px;
            margin-bottom: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex; justify-content: space-between; align-items: center;
        }
        .member-info { font-size: 14px; }
        .member-meta { font-size: 12px; color: #777; }
        .form-box {
            background: #ffffff; border-radius: 8px; padding: 16px;
            margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        label { display: block; margin-top: 8px; font-size: 14px; }
        input[type="text"], select {
            width: 100%; box-sizing: border-box; padding: 8px; margin-top: 4px;
        }
        button {
            padding: 6px 12px; border: none; border-radius: 4px;
            background: #4CAF50; color: #fff; cursor: pointer;
        }
        button.small { font-size: 12px; padding: 4px 8px; }
        button.danger { background: #e74c3c; }
        button:disabled { background: #aaa; }
        .error { color: red; margin-top: 6px; }
        .empty { color: #666; margin-top: 10px; }
        .actions { display: flex; gap: 6px; align-items: center; }
    </style>
</head>
<body>
<div class="container">
    <a href="/">← 팀 목록으로</a>
    <h1 id="title">팀원 관리</h1>

    <div class="form-box">
        <h2>팀원 추가</h2>
        <label>
            사용자 ID
            <input type="text" id="userId" placeholder="users 테이블의 id 값">
        </label>
        <label>
            역할
            <select id="role">
                <option value="PLAYER" selected>PLAYER</option>
                <option value="MANAGER">MANAGER</option>
                <option value="LEADER">LEADER</option>
            </select>
        </label>
        <button id="addBtn">추가</button>
        <div class="error" id="errorMsg"></div>
    </div>

    <h2>현재 팀원</h2>
    <div id="memberContainer"></div>
</div>

<script>
    const params = new URLSearchParams(location.search);
    const teamId = Number(params.get('teamId'));
    const teamName = params.get('teamName') || '팀';

    document.getElementById('title').textContent = teamName + ' 팀원 관리';

    const API_BASE = '/api/team-members';

    async function loadMembers() {
        const container = document.getElementById('memberContainer');
        container.innerHTML = '불러오는 중...';

        try {
            const res = await fetch(API_BASE + '?teamId=' + teamId);
            if (!res.ok) throw new Error('서버 오류: ' + res.status);
            const data = await res.json();

            if (data.length === 0) {
                container.innerHTML = '<div class="empty">아직 등록된 팀원이 없습니다.</div>';
                return;
            }

            container.innerHTML = '';
            data.forEach(m => {
                const div = document.createElement('div');
                div.className = 'member-card';
                div.innerHTML = `
                    <div>
                        <div class="member-info">
                            사용자 ID: <b>${m.userId}</b> / 역할:
                            <select data-id="${m.id}" class="role-select">
                                <option value="PLAYER" ${m.role === 'PLAYER' ? 'selected' : ''}>PLAYER</option>
                                <option value="MANAGER" ${m.role === 'MANAGER' ? 'selected' : ''}>MANAGER</option>
                                <option value="LEADER" ${m.role === 'LEADER' ? 'selected' : ''}>LEADER</option>
                            </select>
                        </div>
                        <div class="member-meta">
                            멤버 ID: ${m.id} / 가입일: ${m.joinedAt ?? '-'}
                        </div>
                    </div>
                    <div class="actions">
                        <button class="small" onclick="changeRole(${m.id}, this.previousElementSibling?.value)">역할 변경</button>
                        <button class="small danger" onclick="removeMember(${m.id})">삭제</button>
                    </div>
                `;
                container.appendChild(div);
            });

        } catch (e) {
            container.innerHTML = '<div class="error">팀원 목록을 불러오는 중 오류가 발생했습니다.</div>';
            console.error(e);
        }
    }

    async function addMember() {
        const userIdEl = document.getElementById('userId');
        const roleEl = document.getElementById('role');
        const errorMsg = document.getElementById('errorMsg');
        const btn = document.getElementById('addBtn');

        errorMsg.textContent = '';

        if (!userIdEl.value.trim()) {
            errorMsg.textContent = '사용자 ID는 필수입니다.';
            return;
        }

        const body = {
            teamId: teamId,
            userId: Number(userIdEl.value.trim()),
            role: roleEl.value
        };

        btn.disabled = true;

        try {
            const res = await fetch(API_BASE, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            if (!res.ok) {
                const txt = await res.text();
                throw new Error(txt);
            }

            userIdEl.value = '';
            roleEl.value = 'PLAYER';

            await loadMembers();

        } catch (e) {
            errorMsg.textContent = '팀원 추가 중 오류: ' + e.message;
            console.error(e);
        } finally {
            btn.disabled = false;
        }
    }

    async function removeMember(id) {
        if (!confirm('정말 삭제할까요?')) return;
        try {
            const res = await fetch(API_BASE + '/' + id, { method: 'DELETE' });
            if (!res.ok) throw new Error('삭제 실패: ' + res.status);
            await loadMembers();
        } catch (e) {
            alert('삭제 중 오류: ' + e.message);
            console.error(e);
        }
    }

    async function changeRole(id) {
        // 선택된 select 찾기
        const selects = document.querySelectorAll('.role-select');
        let role = null;
        selects.forEach(s => {
            if (Number(s.getAttribute('data-id')) === id) {
                role = s.value;
            }
        });
        if (!role) return;

        try {
            const res = await fetch(API_BASE + '/' + id, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ role })
            });
            if (!res.ok) {
                const txt = await res.text();
                throw new Error(txt);
            }
            await loadMembers();
        } catch (e) {
            alert('역할 변경 중 오류: ' + e.message);
            console.error(e);
        }
    }

    document.getElementById('addBtn').addEventListener('click', addMember);
    window.addEventListener('load', loadMembers);
</script>
</body>
</html>
