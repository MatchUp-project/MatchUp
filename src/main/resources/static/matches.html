<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>경기 기록</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; }
        a { text-decoration: none; color: #007bff; }
        h1 { margin-bottom: 10px; }
        .form-box {
            background: #ffffff; border-radius: 8px; padding: 16px;
            margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        label { display: block; margin-top: 8px; font-size: 14px; }
        input[type="text"], input[type="number"], input[type="datetime-local"], textarea {
            width: 100%; box-sizing: border-box; padding: 8px; margin-top: 4px;
        }
        textarea { resize: vertical; }
        button {
            margin-top: 12px; padding: 8px 16px; border: none; border-radius: 4px;
            background: #4CAF50; color: #fff; cursor: pointer;
        }
        button:disabled { background: #aaa; }
        .error { color: red; margin-top: 6px; }
        .empty { color: #666; margin-top: 10px; }

        .match-card {
            background: #ffffff; border-radius: 8px; padding: 12px 16px;
            margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex; gap: 12px;
        }
        .match-info { flex: 1; }
        .match-title { font-weight: bold; font-size: 16px; }
        .match-meta { font-size: 13px; color: #777; margin-top: 4px; }
        .match-summary { font-size: 14px; margin-top: 6px; white-space: pre-wrap; }
        .match-thumb img {
            max-width: 160px; border-radius: 6px; display: block;
        }
        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            background: #eee;
            margin-left: 4px;
        }
    </style>
</head>
<body>
<div class="container">
    <a href="/">← 팀 목록으로</a>
    <h1 id="title">경기 기록</h1>

    <!-- 새 경기 기록 폼 -->
    <div class="form-box">
        <h2>새 경기 기록 추가</h2>
        <p style="font-size:13px; color:#555;">
            * 이 페이지는 <b>우리 팀</b>을 기준으로 경기 기록을 남깁니다.<br>
            팀1(우리 팀)는 URL의 teamId로 자동 설정되고, 여기에 입력하는 상대 팀 ID는 <b>다른 팀의 id</b>입니다.
        </p>

        <label>
            상대 팀 ID (team2Id)
            <input type="number" id="opponentId" placeholder="예: 3">
        </label>

        <label>
            우리 팀 점수
            <input type="number" id="ourScore" placeholder="예: 5">
        </label>

        <label>
            상대 팀 점수
            <input type="number" id="theirScore" placeholder="예: 3">
        </label>

        <label>
            경기 날짜/시간
            <input type="datetime-local" id="matchDate">
        </label>

        <label>
            장소
            <input type="text" id="place" placeholder="예: 잠실야구장">
        </label>

        <label>
            요약
            <textarea id="summary" rows="3" placeholder="경기 내용을 간단히 적어주세요"></textarea>
        </label>

        <label>
            썸네일 이미지 URL (선택)
            <input type="text" id="thumbnailUrl" placeholder="예: https://example.com/image.jpg">
        </label>

        <button id="saveBtn">경기 기록 저장</button>
        <div class="error" id="errorMsg"></div>
    </div>

    <!-- 경기 기록 목록 -->
    <h2>경기 기록 목록</h2>
    <div id="matchContainer"></div>
</div>

<script>
    const params = new URLSearchParams(location.search);
    const teamId = Number(params.get('teamId'));
    const teamName = params.get('teamName') || '우리 팀';

    document.getElementById('title').textContent = teamName + ' 경기 기록';

    const API_BASE = '/api/match-records';

    function formatDateTime(str) {
        if (!str) return '-';
        // LocalDateTime은 "2025-11-20T14:30:00" 이런 식으로 올 거라 그냥 공백으로만 바꿔줌
        return str.replace('T', ' ');
    }

    // 경기 기록 불러오기
    async function loadMatches() {
        const container = document.getElementById('matchContainer');
        container.innerHTML = '불러오는 중...';

        try {
            const res = await fetch(API_BASE + '?teamId=' + teamId);
            if (!res.ok) throw new Error('서버 오류: ' + res.status);
            const data = await res.json();

            if (data.length === 0) {
                container.innerHTML = '<div class="empty">등록된 경기 기록이 없습니다.</div>';
                return;
            }

            container.innerHTML = '';
            data.forEach(m => {
                // 우리 팀 기준으로 홈/원정 판단
                const isTeam1 = m.team1Id === teamId;
                const ourScore = isTeam1 ? m.team1Score : m.team2Score;
                const theirScore = isTeam1 ? m.team2Score : m.team1Score;
                const opponentId = isTeam1 ? m.team2Id : m.team1Id;
                const resultText =
                    ourScore > theirScore ? '승' :
                    ourScore < theirScore ? '패' : '무';

                const card = document.createElement('div');
                card.className = 'match-card';
                card.innerHTML = `
                    <div class="match-info">
                        <div class="match-title">
                            vs 팀 ID ${opponentId}
                            <span class="badge">${resultText}</span>
                        </div>
                        <div class="match-meta">
                            스코어: ${ourScore} : ${theirScore}
                            &nbsp;|&nbsp; 날짜: ${formatDateTime(m.matchDate)}
                            &nbsp;|&nbsp; 장소: ${m.place || '-'}
                            <br>
                            (team1Id=${m.team1Id}, team2Id=${m.team2Id})
                        </div>
                        <div class="match-summary">${m.summary ? m.summary : ''}</div>
                    </div>
                    <div class="match-thumb">
                        ${m.thumbnailUrl ? `<img src="${m.thumbnailUrl}" alt="thumbnail">` : ''}
                    </div>
                `;
                container.appendChild(card);
            });

        } catch (e) {
            container.innerHTML = '<div class="error">경기 기록을 불러오는 중 오류가 발생했습니다.</div>';
            console.error(e);
        }
    }

    // 경기 기록 저장
    async function saveMatch() {
        const opponentEl = document.getElementById('opponentId');
        const ourScoreEl = document.getElementById('ourScore');
        const theirScoreEl = document.getElementById('theirScore');
        const dateEl = document.getElementById('matchDate');
        const placeEl = document.getElementById('place');
        const summaryEl = document.getElementById('summary');
        const thumbEl = document.getElementById('thumbnailUrl');
        const errorMsg = document.getElementById('errorMsg');
        const btn = document.getElementById('saveBtn');

        errorMsg.textContent = '';

        const opponentRaw = opponentEl.value.trim();
        const ourRaw = ourScoreEl.value.trim();
        const theirRaw = theirScoreEl.value.trim();

        if (!opponentRaw) {
            errorMsg.textContent = '상대 팀 ID를 입력하세요.';
            return;
        }
        if (!ourRaw || !theirRaw) {
            errorMsg.textContent = '양 팀 점수를 모두 입력하세요.';
            return;
        }

        const opponentId = Number(opponentRaw);
        const ourScore = Number(ourRaw);
        const theirScore = Number(theirRaw);

        if (Number.isNaN(opponentId) || opponentId <= 0) {
            errorMsg.textContent = '상대 팀 ID는 양의 정수여야 합니다.';
            return;
        }
        if (Number.isNaN(ourScore) || Number.isNaN(theirScore)) {
            errorMsg.textContent = '점수는 숫자로 입력해야 합니다.';
            return;
        }

        const body = {
            team1Id: teamId,
            team2Id: opponentId,
            team1Score: ourScore,
            team2Score: theirScore,
            matchDate: dateEl.value ? dateEl.value : null,
            place: placeEl.value.trim(),
            summary: summaryEl.value.trim(),
            thumbnailUrl: thumbEl.value.trim()
        };

        btn.disabled = true;

        try {
            const res = await fetch(API_BASE, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });

            if (!res.ok) {
                const txt = await res.text();
                throw new Error(txt);
            }

            // 폼 초기화
            opponentEl.value = '';
            ourScoreEl.value = '';
            theirScoreEl.value = '';
            dateEl.value = '';
            placeEl.value = '';
            summaryEl.value = '';
            thumbEl.value = '';

            await loadMatches();

        } catch (e) {
            errorMsg.textContent = '경기 기록 저장 중 오류: ' + e.message;
            console.error(e);
        } finally {
            btn.disabled = false;
        }
    }

    document.getElementById('saveBtn').addEventListener('click', saveMatch);
    window.addEventListener('load', loadMatches);
</script>
</body>
</html>
